//@version=6
strategy("MACD Dual + KAMA Strategy", shorttitle="MACD+KAMA Strategy", overlay=true, pyramiding=0, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============ PRIMARY MACD INPUTS ============
timeframe1 = input.timeframe("", title="Timeframe", group="Primary MACD")
fastLength = input.int(60, title="Fast Length", minval=1, group="Primary MACD")
slowLength = input.int(130, title="Slow Length", minval=1, group="Primary MACD")
src = input.source(close, title="Source", group="Primary MACD")
signalSmoothing = input.int(45, title="Signal Smoothing", minval=1, group="Primary MACD")
oscillatorMAType = input.string("EMA", title="Oscillator MA Type", options=["EMA", "SMA"], group="Primary MACD")
signalLineMAType = input.string("EMA", title="Signal Line MA Type", options=["EMA", "SMA"], group="Primary MACD")

// ============ SECONDARY MACD INPUTS ============
timeframe2 = input.timeframe("240", title="Timeframe", group="Secondary MACD")
fastLength2 = input.int(12, title="Fast Length", minval=1, group="Secondary MACD")
slowLength2 = input.int(26, title="Slow Length", minval=1, group="Secondary MACD")
src2 = input.source(close, title="Source", group="Secondary MACD")
signalSmoothing2 = input.int(9, title="Signal Smoothing", minval=1, group="Secondary MACD")
oscillatorMAType2 = input.string("EMA", title="Oscillator MA Type", options=["EMA", "SMA"], group="Secondary MACD")
signalLineMAType2 = input.string("EMA", title="Signal Line MA Type", options=["EMA", "SMA"], group="Secondary MACD")

// ============ KAMA BASELINE INPUTS ============
kamaLength = input.int(22, title="Length", minval=1, group="KAMA Baseline")
kamaFastLength = input.int(2, title="Fast Length", minval=1, group="KAMA Baseline")
kamaSlowLength = input.int(30, title="Slow Length", minval=1, group="KAMA Baseline")
kamaSrc = input.source(close, title="Source", group="KAMA Baseline")

// ============ RISK MANAGEMENT INPUTS ============
atrLength = input.int(22, title="ATR Length", minval=1, group="Risk Management")
atrMultiplier = input.float(3.0, title="ATR Multiplier for Stop Loss", minval=0.1, step=0.1, group="Risk Management")

// ============ DEBUG INPUTS ============
showDebug = input.bool(true, title="Show Debug Info", group="Debug")
debugTablePosition = input.string("top_right", title="Debug Table Position", options=["top_left", "top_center", "top_right", "middle_left", "middle_center", "middle_right", "bottom_left", "bottom_center", "bottom_right"], group="Debug")

// ============ CALCULATION ============
// MACD Calculation Function
calcMACD(src, fastLen, slowLen, signalLen, oscType, sigType) =>
    fastMA = oscType == "EMA" ? ta.ema(src, fastLen) : ta.sma(src, fastLen)
    slowMA = oscType == "EMA" ? ta.ema(src, slowLen) : ta.sma(src, slowLen)
    macdLine = fastMA - slowMA
    signalLine = sigType == "EMA" ? ta.ema(macdLine, signalLen) : ta.sma(macdLine, signalLen)
    histogram = macdLine - signalLine
    [macdLine, histogram]

// Primary MACD
[fastMA, slowMA, srcData] = request.security(syminfo.tickerid, timeframe1, [oscillatorMAType == "EMA" ? ta.ema(src, fastLength) : ta.sma(src, fastLength), oscillatorMAType == "EMA" ? ta.ema(src, slowLength) : ta.sma(src, slowLength), src])

macdLine = fastMA - slowMA
signalLine = signalLineMAType == "EMA" ? ta.ema(macdLine, signalSmoothing) : ta.sma(macdLine, signalSmoothing)
histogram = macdLine - signalLine

// Secondary MACD
[macdLine2, histogram2] = request.security(syminfo.tickerid, timeframe2, calcMACD(src2, fastLength2, slowLength2, signalSmoothing2, oscillatorMAType2, signalLineMAType2), lookahead=barmerge.lookahead_off)

// KAMA Baseline
kama(src, length, fastLength, slowLength) =>
    momentum = math.abs(src - src[length])
    volatility = math.sum(math.abs(src - src[1]), length)
    er = volatility != 0 ? momentum / volatility : 0
    fastAlpha = 2 / (fastLength + 1)
    slowAlpha = 2 / (slowLength + 1)
    sc = math.pow(er * (fastAlpha - slowAlpha) + slowAlpha, 2)
    var float kama = na
    kama := na(kama[1]) ? src : kama[1] + sc * (src - kama[1])
    kama

kamaValue = kama(kamaSrc, kamaLength, kamaFastLength, kamaSlowLength)

// ATR for Stop Loss
atrValue = ta.atr(atrLength)

// ============ STRATEGY LOGIC ============
// Buy Conditions
histogramGreen = histogram > histogram[1]  // Histogram is rising/green

secondaryMacdAboveZero = macdLine2 > 0

priceAboveKama = close > kamaValue

longCondition = histogramGreen and secondaryMacdAboveZero and priceAboveKama

// Exit Conditions
priceBelowKama = close < kamaValue
secondaryMacdBelowZero = macdLine2 < 0
exitCondition = priceBelowKama and secondaryMacdBelowZero

// Stop Loss Level
stopLossLevel = kamaValue - (atrValue * atrMultiplier)

// Entry
if longCondition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Stop Loss", "Long", stop=stopLossLevel)

// Exit
if exitCondition and strategy.position_size > 0
    strategy.close("Long", comment="Exit Signal")

// Update Stop Loss on each bar if in position
if strategy.position_size > 0
    strategy.exit("Stop Loss", "Long", stop=stopLossLevel)

// ============ PLOTTING ============
// KAMA on price chart
plot(kamaValue, title="KAMA", color=color.new(#2962ff, 0), linewidth=2)

// Plot stop loss level for visualization
plot(strategy.position_size > 0 ? stopLossLevel : na, title="Stop Loss", color=color.red, style=plot.style_linebr, linewidth=1)

// Plot entry signals
plotshape(longCondition and strategy.position_size == 0, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(exitCondition and strategy.position_size > 0, title="Exit Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// ============ DEBUG TABLE ============
if showDebug
    var table debugTable = table.new(position=debugTablePosition == "top_left" ? position.top_left : debugTablePosition == "top_center" ? position.top_center : debugTablePosition == "top_right" ? position.top_right : debugTablePosition == "middle_left" ? position.middle_left : debugTablePosition == "middle_center" ? position.middle_center : debugTablePosition == "middle_right" ? position.middle_right : debugTablePosition == "bottom_left" ? position.bottom_left : debugTablePosition == "bottom_center" ? position.bottom_center : position.bottom_right, columns=2, rows=10, bgcolor=color.new(color.black, 10), border_width=1)
    
    // Headers
    table.cell(debugTable, 0, 0, "Condition", text_color=color.white, bgcolor=color.new(color.gray, 30))
    table.cell(debugTable, 1, 0, "Status", text_color=color.white, bgcolor=color.new(color.gray, 30))
    
    // Primary MACD Histogram
    table.cell(debugTable, 0, 1, "Histogram Green", text_color=color.white)
    table.cell(debugTable, 1, 1, histogramGreen ? "✓ YES" : "✗ NO", text_color=histogramGreen ? color.green : color.red)
    
    // Histogram Value
    table.cell(debugTable, 0, 2, "Histogram Value", text_color=color.white)
    table.cell(debugTable, 1, 2, str.tostring(histogram, "#.####"), text_color=color.white)
    
    // Secondary MACD
    table.cell(debugTable, 0, 3, "Secondary MACD > 0", text_color=color.white)
    table.cell(debugTable, 1, 3, secondaryMacdAboveZero ? "✓ YES" : "✗ NO", text_color=secondaryMacdAboveZero ? color.green : color.red)
    
    // Secondary MACD Value
    table.cell(debugTable, 0, 4, "Secondary MACD", text_color=color.white)
    table.cell(debugTable, 1, 4, str.tostring(macdLine2, "#.####"), text_color=color.white)
    
    // Price above KAMA
    table.cell(debugTable, 0, 5, "Price Above KAMA", text_color=color.white)
    table.cell(debugTable, 1, 5, priceAboveKama ? "✓ YES" : "✗ NO", text_color=priceAboveKama ? color.green : color.red)
    
    // Price vs KAMA
    table.cell(debugTable, 0, 6, "Price vs KAMA", text_color=color.white)
    table.cell(debugTable, 1, 6, close > kamaValue ? "Above" : "Below", text_color=close > kamaValue ? color.green : color.red)
    
    // Long Signal
    table.cell(debugTable, 0, 7, "LONG SIGNAL", text_color=color.white, bgcolor=color.new(color.blue, 50))
    table.cell(debugTable, 1, 7, longCondition ? "✓✓✓ BUY ✓✓✓" : "No Signal", text_color=longCondition ? color.lime : color.orange, bgcolor=color.new(color.blue, 50))
    
    // Position Status
    table.cell(debugTable, 0, 8, "Position", text_color=color.white)
    table.cell(debugTable, 1, 8, strategy.position_size > 0 ? "OPEN" : "CLOSED", text_color=strategy.position_size > 0 ? color.yellow : color.gray)
    
    // Exit Signal
    table.cell(debugTable, 0, 9, "Exit Signal", text_color=color.white)
    table.cell(debugTable, 1, 9, exitCondition ? "✓ EXIT" : "No Exit", text_color=exitCondition ? color.red : color.gray)
